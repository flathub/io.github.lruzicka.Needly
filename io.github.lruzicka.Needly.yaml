app-id: io.github.lruzicka.Needly
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
command: needly

finish-args:
  - --share=ipc
  - --socket=x11
  - --filesystem=xdg-documents
  - --filesystem=xdg-run/libvirt

build-options:
  env:
    PKG_CONFIG_PATH: /app/lib/pkgconfig:/app/share/pkgconfig

modules:
  - name: tcl
    buildsystem: autotools
    subdir: unix
    post-install:
      - chmod 755 /app/lib/libtcl*.so
    sources:
      - type: archive
        url: https://prdownloads.sourceforge.net/tcl/tcl8.6.14-src.tar.gz
        sha256: 5880225babf7954c58d4fb0f5cf6279104ce1cd6aa9b71e9a6322540e1c4de66

  - name: tk
    buildsystem: autotools
    subdir: unix
    config-opts:
      - --with-tcl=/app/lib
    post-install:
      - chmod 755 /app/lib/libtk*.so
    sources:
      - type: archive
        url: https://prdownloads.sourceforge.net/tcl/tk8.6.14-src.tar.gz
        sha256: 8ffdb720f47a6ca6107eac2dd877e30b0ef7fac14f3a84ebbd0b3612cee41a94

  - name: python
    buildsystem: autotools
    config-opts:
      - --prefix=/app
      - --enable-shared
      - --with-ensurepip=install
      - --with-tcltk-includes=-I/app/include
      - --with-tcltk-libs=-L/app/lib
    build-options:
      env:
        CPPFLAGS: -I/app/include
        LDFLAGS: -L/app/lib
        LD_LIBRARY_PATH: /app/lib
    sources:
    - type: archive
      url: https://www.python.org/ftp/python/3.12.8/Python-3.12.8.tar.xz
      sha256: c909157bb25ec114e5869124cc2a9c4a4d4c1e957ca4ff553f1edc692101154e

  - name: python-flit-core
    buildsystem: simple
    build-commands:
      - /app/bin/pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} flit_core
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/source/f/flit_core/flit_core-3.10.1.tar.gz
        sha256: 66e5b87874a0d6e39691f0e22f09306736b633548670ad3c09ec9db03c5662f7


  - name: python-setuptools
    buildsystem: simple
    build-commands:
      - /app/bin/pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} --no-build-isolation setuptools
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/source/s/setuptools/setuptools-75.6.0.tar.gz
        sha256: 8199222558df7c86216af4f84c30e9b34a61d8ba19366cc914424cdbd28252f6

  - name: python-wheel
    buildsystem: simple
    build-commands:
      - /app/bin/pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} --no-build-isolation wheel
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/source/w/wheel/wheel-0.45.1.tar.gz
        sha256: 661e1abd9198507b1409a20c02106d9670b2576e916d58f520316666abca6729

  - name: libtirpc
    config-opts:
      - --disable-gssapi
      - --libdir=/app/lib
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/sourceforge/libtirpc/libtirpc-1.3.7.tar.bz2
        sha256: b47d3ac19d3549e54a05d0019a6c400674da716123858cfdb6d3bdd70a66c702

  - name: rpcsvc-proto
    buildsystem: autotools
    sources:
      - type: archive
        url: https://github.com/thkukuk/rpcsvc-proto/archive/v1.4.4.tar.gz
        sha256: 7988641deae8463303b6273d7af98ece09111c385d4c9134a142a5fad3cdfef8

  - name: python-docutils
    buildsystem: simple
    build-commands:
      - /app/bin/pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} docutils --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/source/d/docutils/docutils-0.21.2.tar.gz
        sha256: 3a6b18732edf182daa3cd12775bbb338cf5691468f91eeeb109deff6ebfa986f

  - name: libvirt
    buildsystem: meson
    config-opts:
      - --localstatedir=/var
      - -Ddriver_qemu=disabled
      - -Ddriver_openvz=disabled
      - -Ddriver_lxc=disabled
      - -Ddriver_vbox=disabled
      - -Ddriver_libxl=disabled
      - -Ddriver_esx=disabled
      - -Ddriver_hyperv=disabled
      - -Ddriver_vmware=disabled
    sources:
      - type: archive
        url: https://libvirt.org/sources/libvirt-10.9.0.tar.xz
        sha256: 2473db10bb9b9992c02897cef4b26ae58885ff357cea5f9ce3ec9e008f6b5b3a

  - name: needly-dependencies
    buildsystem: simple
    build-commands:
      - /app/bin/pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} Pillow libvirt-python --no-build-isolation --no-deps
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/source/p/pillow/pillow-11.0.0.tar.gz
        sha256: 72bacbaf24ac003fea9bff9837d1eedb6088758d41e100c1552930151f677739
      - type: file
        url: https://files.pythonhosted.org/packages/source/l/libvirt-python/libvirt-python-11.0.0.tar.gz
        sha256: cee825a53c6438c5bc84b4250b35493a8e504d5d8075d3d2069ffaf7090846f8

  - name: needly
    buildsystem: simple
    build-commands:
      - /app/bin/pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} --no-deps needly
      - install -Dm644 io.github.lruzicka.Needly.png /app/share/icons/hicolor/128x128/apps/io.github.lruzicka.Needly.png
      - install -Dm644 io.github.lruzicka.Needly.desktop /app/share/applications/io.github.lruzicka.Needly.desktop
      - install -Dm644 io.github.lruzicka.Needly.metainfo.xml /app/share/metainfo/io.github.lruzicka.Needly.metainfo.xml
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/38/a2/be0e52dcf41d03b5446514809560102eb5286a3a51349b14dbd0a272e366/needly-2.5.95-py3-none-any.whl
        sha256: f9f82cd596901d57cc29ef6ea7d24333cf76f6c8cdcea2551b247306bf14c525
      - type: file
        path: io.github.lruzicka.Needly.png
      - type: file
        path: io.github.lruzicka.Needly.desktop
      - type: file
        path: io.github.lruzicka.Needly.metainfo.xml
